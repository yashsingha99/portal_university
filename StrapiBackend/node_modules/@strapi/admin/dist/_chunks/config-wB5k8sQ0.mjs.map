{"version":3,"file":"config-wB5k8sQ0.mjs","sources":["../../_internal/node/webpack/aliases.ts","../../_internal/node/webpack/config.ts"],"sourcesContent":["import path from 'path';\nimport findRoot from 'find-root';\nimport type { StrapiMonorepo } from '../core/monorepo';\nimport { getMonorepoAliases } from '../core/aliases';\n\n/**\n * @deprecated we will not support aliasing dependencies from V5.\n */\nconst adminPackageAliases = [\n  '@strapi/design-system',\n  '@strapi/helper-plugin',\n  '@strapi/icons',\n  'date-fns',\n  'formik',\n  'history',\n  'immer',\n  'qs',\n  'lodash',\n  'react',\n  'react-dnd',\n  'react-dnd-html5-backend',\n  'react-dom',\n  'react-error-boundary',\n  'react-helmet',\n  'react-is',\n  'react-intl',\n  'react-query',\n  'react-redux',\n  'react-router-dom',\n  'react-window',\n  'react-select',\n  'redux',\n  'reselect',\n  'styled-components',\n  'yup',\n] as const;\n\n/**\n * @deprecated we will not support aliasing dependencies from V5.\n */\nconst getAdminDependencyAliases = (monorepo?: StrapiMonorepo) =>\n  adminPackageAliases\n    .filter(\n      (moduleName) => !monorepo?.path || (monorepo.path && moduleName !== '@strapi/helper-plugin')\n    )\n    .reduce((acc, moduleName) => {\n      /**\n       * We use `findRoot` instead of `resolveFrom` here because we don't want to\n       * choose a particular file e.g. the CJS version over the ESM because the\n       * bundler should decide this, so insted find-root is more appropriate.\n       *\n       * When we remove these aliases in V5 we can also remove the `find-root` package.\n       */\n      acc[`${moduleName}$`] = findRoot(require.resolve(moduleName));\n      return acc;\n    }, {} as Record<string, string>);\n\nconst getAliases = (cwd: string, monorepo?: StrapiMonorepo) => {\n  const adminAliases = getAdminDependencyAliases(monorepo);\n  const monorepoAliases = getMonorepoAliases({ monorepo });\n\n  return {\n    ...adminAliases,\n    ...monorepoAliases,\n  };\n};\n\nexport { getAliases };\n","import browserslistToEsbuild from 'browserslist-to-esbuild';\nimport { ESBuildMinifyPlugin } from 'esbuild-loader';\nimport HtmlWebpackPlugin from 'html-webpack-plugin';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport ForkTsCheckerPlugin from 'fork-ts-checker-webpack-plugin';\nimport { BundleAnalyzerPlugin } from 'webpack-bundle-analyzer';\nimport crypto from 'node:crypto';\nimport path from 'node:path';\nimport { Configuration, DefinePlugin, HotModuleReplacementPlugin } from 'webpack';\nimport ReactRefreshWebpackPlugin from '@pmmmwh/react-refresh-webpack-plugin';\n\nimport { getAliases } from './aliases';\nimport { loadStrapiMonorepo } from '../core/monorepo';\nimport type { BuildContext } from '../createBuildContext';\nimport { getUserConfig } from '../core/config';\n\nconst resolveBaseConfig = async (ctx: BuildContext) => {\n  const monorepo = await loadStrapiMonorepo(ctx.cwd);\n\n  const target = browserslistToEsbuild(ctx.target);\n\n  return {\n    experiments: {\n      topLevelAwait: true,\n    },\n    entry: {\n      main: [`./${ctx.entry}`],\n    },\n    resolve: {\n      alias: getAliases(ctx.cwd, monorepo),\n      extensions: ['.js', '.jsx', '.react.js', '.ts', '.tsx'],\n    },\n    module: {\n      rules: [\n        {\n          test: /\\.(ts|tsx)$/,\n          loader: require.resolve('esbuild-loader'),\n          options: {\n            loader: 'tsx',\n            target,\n            jsx: 'automatic',\n          },\n        },\n        {\n          test: /\\.(js|jsx|mjs)$/,\n          use: {\n            loader: require.resolve('esbuild-loader'),\n            options: {\n              loader: 'jsx',\n              target,\n              jsx: 'automatic',\n            },\n          },\n        },\n        {\n          test: /\\.m?js/,\n          resolve: {\n            fullySpecified: false,\n          },\n        },\n        {\n          test: /\\.css$/i,\n          use: [require.resolve('style-loader'), require.resolve('css-loader')],\n        },\n        {\n          test: /\\.(svg|eot|otf|ttf|woff|woff2)$/,\n          type: 'asset/resource',\n        },\n        {\n          test: [/\\.bmp$/, /\\.gif$/, /\\.jpe?g$/, /\\.png$/, /\\.ico$/],\n          type: 'asset',\n          parser: {\n            dataUrlCondition: {\n              maxSize: 1000,\n            },\n          },\n        },\n        {\n          test: /\\.(mp4|webm)$/,\n          type: 'asset',\n          parser: {\n            dataUrlCondition: {\n              maxSize: 10000,\n            },\n          },\n        },\n      ],\n    },\n    plugins: [\n      new HtmlWebpackPlugin({\n        inject: true,\n        template: path.resolve(ctx.runtimeDir, 'index.html'),\n      }),\n      new DefinePlugin(\n        Object.entries(ctx.env).reduce<Record<string, string>>((acc, [key, value]) => {\n          acc[`process.env.${key}`] = JSON.stringify(value);\n          return acc;\n        }, {})\n      ),\n      ctx.tsconfig &&\n        new ForkTsCheckerPlugin({\n          typescript: {\n            configFile: ctx.tsconfig.path,\n            configOverwrite: {\n              compilerOptions: {\n                sourceMap: ctx.options.sourcemaps,\n              },\n            },\n          },\n        }),\n    ].filter(Boolean),\n  };\n};\n\nconst resolveDevelopmentConfig = async (ctx: BuildContext): Promise<Configuration> => {\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    cache: {\n      type: 'filesystem',\n      // version cache when there are changes to aliases\n      buildDependencies: {\n        config: [__filename],\n      },\n      version: crypto\n        .createHash('md5')\n        .update(Object.entries(baseConfig.resolve.alias).join())\n        .digest('hex'),\n    },\n    entry: {\n      ...baseConfig.entry,\n      main: [\n        `${require.resolve('webpack-hot-middleware/client')}?path=/__webpack_hmr`,\n        ...baseConfig.entry.main,\n      ],\n    },\n    stats: 'errors-warnings',\n    mode: 'development',\n    devtool: 'inline-source-map',\n    output: {\n      filename: '[name].js',\n      path: ctx.distPath,\n      publicPath: ctx.basePath,\n    },\n    infrastructureLogging: {\n      level: 'error',\n    },\n    plugins: [\n      ...baseConfig.plugins,\n      new HotModuleReplacementPlugin(),\n      new ReactRefreshWebpackPlugin(),\n    ],\n  };\n};\n\nconst resolveProductionConfig = async (ctx: BuildContext): Promise<Configuration> => {\n  const target = browserslistToEsbuild(ctx.target);\n\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    stats: 'errors-only',\n    mode: 'production',\n    bail: true,\n    devtool: ctx.options.sourcemaps ? 'source-map' : false,\n    output: {\n      path: ctx.distPath,\n      publicPath: ctx.basePath,\n      // Utilize long-term caching by adding content hashes (not compilation hashes)\n      // to compiled assets for production\n      filename: '[name].[contenthash:8].js',\n      chunkFilename: '[name].[contenthash:8].chunk.js',\n    },\n    optimization: {\n      minimize: ctx.options.minify,\n      minimizer: [\n        new ESBuildMinifyPlugin({\n          target,\n          css: true, // Apply minification to CSS assets\n        }),\n      ],\n      moduleIds: 'deterministic',\n      runtimeChunk: true,\n    },\n    plugins: [\n      ...baseConfig.plugins,\n      new MiniCssExtractPlugin({\n        filename: '[name].[chunkhash].css',\n        chunkFilename: '[name].[chunkhash].chunkhash.css',\n        ignoreOrder: true,\n      }),\n      ctx.options.stats && new BundleAnalyzerPlugin(),\n    ].filter(Boolean),\n  };\n};\n\nconst USER_CONFIGS = ['webpack.config.js', 'webpack.config.mjs', 'webpack.config.ts'];\n\ntype UserWebpackConfig = (config: Configuration, webpack: unknown) => Configuration;\n\nconst mergeConfigWithUserConfig = async (config: Configuration, ctx: BuildContext) => {\n  const userConfig = await getUserConfig<UserWebpackConfig>(USER_CONFIGS, ctx);\n\n  if (userConfig) {\n    if (typeof userConfig === 'function') {\n      const webpack = await import('webpack');\n      return userConfig(config, webpack);\n    } else {\n      ctx.logger.warn(\n        `You've exported something other than a function from ${path.join(\n          ctx.appDir,\n          'src',\n          'admin',\n          'webpack.config'\n        )}, this will ignored.`\n      );\n    }\n  }\n\n  return config;\n};\n\nexport { resolveProductionConfig, resolveDevelopmentConfig, mergeConfigWithUserConfig };\n"],"names":[],"mappings":"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"}