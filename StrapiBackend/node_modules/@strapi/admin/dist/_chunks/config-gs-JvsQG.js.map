{"version":3,"file":"config-gs-JvsQG.js","sources":["../../_internal/node/vite/plugins.ts","../../_internal/node/vite/config.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport { getDocumentHTML } from '../staticFiles';\nimport type { BuildContext } from '../createBuildContext';\n\nconst buildFilesPlugin = (ctx: BuildContext): Plugin => {\n  const CHUNK_ID = '.strapi/client/app.js';\n\n  return {\n    name: 'strapi/server/build-files',\n    apply: 'build',\n    buildStart() {\n      this.emitFile({\n        type: 'chunk',\n        id: CHUNK_ID,\n        name: 'strapi',\n      });\n    },\n    async generateBundle(_options, outputBundle) {\n      const bundle = outputBundle;\n      const entryFile = Object.values(bundle).find(\n        (file) =>\n          file.type === 'chunk' && file.name === 'strapi' && file.facadeModuleId?.endsWith(CHUNK_ID)\n      );\n\n      if (!entryFile) {\n        throw new Error(`Failed to find entry file in bundle (${CHUNK_ID})`);\n      }\n\n      if (entryFile.type !== 'chunk') {\n        throw new Error('Entry file is not a chunk');\n      }\n\n      const entryFileName = entryFile.fileName;\n      const entryPath = ['/admin'.replace(/\\/+$/, ''), entryFileName].join('/');\n\n      this.emitFile({\n        type: 'asset',\n        fileName: 'index.html',\n        source: getDocumentHTML({\n          logger: ctx.logger,\n          props: {\n            entryPath,\n          },\n        }),\n      });\n    },\n  };\n};\n\nexport { buildFilesPlugin };\n","import type { InlineConfig, UserConfig } from 'vite';\nimport browserslistToEsbuild from 'browserslist-to-esbuild';\nimport react from '@vitejs/plugin-react-swc';\n\nimport { getUserConfig } from '../core/config';\nimport { loadStrapiMonorepo } from '../core/monorepo';\nimport { getMonorepoAliases } from '../core/aliases';\nimport type { BuildContext } from '../createBuildContext';\nimport { buildFilesPlugin } from './plugins';\n\nconst resolveBaseConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const target = browserslistToEsbuild(ctx.target);\n\n  return {\n    root: ctx.cwd,\n    build: {\n      emptyOutDir: false, // Rely on CLI to do this\n      outDir: ctx.distDir,\n      target,\n    },\n    cacheDir: 'node_modules/.strapi/vite',\n    configFile: false,\n    define: {\n      'process.env': ctx.env,\n    },\n    envPrefix: 'STRAPI_ADMIN_',\n    optimizeDeps: {\n      include: [\n        // pre-bundle React dependencies to avoid React duplicates,\n        // even if React dependencies are not direct dependencies\n        // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\n        'react',\n        `react/jsx-runtime`,\n        'react-dom/client',\n        'styled-components',\n        'react-router-dom',\n      ],\n    },\n    resolve: {\n      // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\n      dedupe: ['react', 'react-dom', 'react-router-dom', 'styled-components'],\n    },\n    plugins: [react(), buildFilesPlugin(ctx)],\n  };\n};\n\nconst resolveProductionConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const {\n    options: { minify, sourcemaps },\n  } = ctx;\n\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    base: ctx.basePath,\n    logLevel: 'silent',\n    mode: 'production',\n    build: {\n      ...baseConfig.build,\n      assetsDir: '',\n      minify,\n      sourcemap: sourcemaps,\n      rollupOptions: {\n        input: {\n          strapi: ctx.entry,\n        },\n      },\n    },\n  };\n};\n\nconst resolveDevelopmentConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\n  const monorepo = await loadStrapiMonorepo(ctx.cwd);\n  const baseConfig = await resolveBaseConfig(ctx);\n\n  return {\n    ...baseConfig,\n    mode: 'development',\n    resolve: {\n      ...baseConfig.resolve,\n      alias: {\n        ...baseConfig.resolve?.alias,\n        ...getMonorepoAliases({ monorepo }),\n      },\n    },\n    server: {\n      middlewareMode: true,\n      open: ctx.options.open,\n      hmr: true,\n    },\n    appType: 'custom',\n  };\n};\n\nconst USER_CONFIGS = ['vite.config.js', 'vite.config.mjs', 'vite.config.ts'];\n\ntype UserViteConfig = (config: UserConfig) => UserConfig;\n\nconst mergeConfigWithUserConfig = async (config: InlineConfig, ctx: BuildContext) => {\n  const userConfig = await getUserConfig<UserViteConfig>(USER_CONFIGS, ctx);\n\n  if (userConfig) {\n    return userConfig(config);\n  }\n\n  return config;\n};\n\nexport { mergeConfigWithUserConfig, resolveProductionConfig, resolveDevelopmentConfig };\n"],"names":["getDocumentHTML","browserslistToEsbuild","react","loadStrapiMonorepo","getMonorepoAliases","config","getUserConfig"],"mappings":"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"}