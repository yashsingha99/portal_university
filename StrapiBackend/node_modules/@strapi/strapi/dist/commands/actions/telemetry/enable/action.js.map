{"version":3,"file":"action.js","sources":["../../../../../src/commands/actions/telemetry/enable/action.ts"],"sourcesContent":["import { resolve } from 'path';\nimport { randomUUID } from 'crypto';\nimport fse from 'fs-extra';\nimport chalk from 'chalk';\nimport fetch from 'node-fetch';\nimport machineID from '../../../../utils/machine-id';\n\ntype PackageJson = {\n  strapi?: {\n    uuid?: string;\n    telemetryDisabled?: boolean;\n  };\n};\n\nconst readPackageJSON = async (path: string) => {\n  try {\n    const packageObj = await fse.readJson(path);\n    return packageObj;\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n    } else {\n      throw err;\n    }\n  }\n};\n\nconst writePackageJSON = async (path: string, file: object, spacing: number) => {\n  try {\n    await fse.writeJson(path, file, { spaces: spacing });\n    return true;\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n      console.log(\n        `${chalk.yellow(\n          'Warning'\n        )}: There has been an error, please set \"telemetryDisabled\": false in the \"strapi\" object of your package.json manually.`\n      );\n\n      return false;\n    }\n\n    throw err;\n  }\n};\n\nconst generateNewPackageJSON = (packageObj: PackageJson) => {\n  if (!packageObj.strapi) {\n    return {\n      ...packageObj,\n      strapi: {\n        uuid: randomUUID(),\n        telemetryDisabled: false,\n      },\n    };\n  }\n  return {\n    ...packageObj,\n    strapi: {\n      ...packageObj.strapi,\n      uuid: packageObj.strapi.uuid ? packageObj.strapi.uuid : randomUUID(),\n      telemetryDisabled: false,\n    },\n  };\n};\n\nconst sendEvent = async (uuid: string) => {\n  try {\n    const event = 'didOptInTelemetry';\n\n    await fetch('https://analytics.strapi.io/api/v2/track', {\n      method: 'POST',\n      body: JSON.stringify({\n        event,\n        deviceId: machineID(),\n        groupProperties: { projectId: uuid },\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Strapi-Event': event,\n      },\n    });\n  } catch (e) {\n    // ...\n  }\n};\n\nasync function optInTelemetry() {\n  const packageJSONPath = resolve(process.cwd(), 'package.json');\n  const exists = await fse.pathExists(packageJSONPath);\n\n  if (!exists) {\n    console.log(`${chalk.yellow('Warning')}: could not find package.json`);\n    process.exit(0);\n  }\n\n  const packageObj = await readPackageJSON(packageJSONPath);\n\n  if (packageObj.strapi && packageObj.strapi.uuid) {\n    if (packageObj.strapi.telemetryDisabled === false) {\n      console.log(`${chalk.yellow('Warning:')} telemetry is already enabled`);\n      process.exit(0);\n    }\n  }\n\n  const updatedPackageJSON = generateNewPackageJSON(packageObj);\n\n  const write = await writePackageJSON(packageJSONPath, updatedPackageJSON, 2);\n\n  if (!write) {\n    process.exit(0);\n  }\n\n  await sendEvent(updatedPackageJSON.strapi.uuid);\n  console.log(`${chalk.green('Successfully opted into and enabled Strapi telemetry')}`);\n  process.exit(0);\n}\n\nexport default optInTelemetry;\n"],"names":["path","fse","chalk","randomUUID","fetch","machineID","resolve"],"mappings":";;;;;;;;;;;AAcA,MAAM,kBAAkB,OAAOA,UAAiB;AAC1C,MAAA;AACF,UAAM,aAAa,MAAMC,aAAAA,QAAI,SAASD,KAAI;AACnC,WAAA;AAAA,WACA,KAAK;AACZ,QAAI,eAAe,OAAO;AAChB,cAAA,MAAM,GAAGE,eAAAA,QAAM,IAAI,OAAO,CAAC,KAAK,IAAI,OAAO,EAAE;AAAA,IAAA,OAChD;AACC,YAAA;AAAA,IACR;AAAA,EACF;AACF;AAEA,MAAM,mBAAmB,OAAOF,OAAc,MAAc,YAAoB;AAC1E,MAAA;AACF,UAAMC,aAAAA,QAAI,UAAUD,OAAM,MAAM,EAAE,QAAQ,SAAS;AAC5C,WAAA;AAAA,WACA,KAAK;AACZ,QAAI,eAAe,OAAO;AAChB,cAAA,MAAM,GAAGE,eAAAA,QAAM,IAAI,OAAO,CAAC,KAAK,IAAI,OAAO,EAAE;AAC7C,cAAA;AAAA,QACN,GAAGA,eAAM,QAAA;AAAA,UACP;AAAA,QACD,CAAA;AAAA,MAAA;AAGI,aAAA;AAAA,IACT;AAEM,UAAA;AAAA,EACR;AACF;AAEA,MAAM,yBAAyB,CAAC,eAA4B;AACtD,MAAA,CAAC,WAAW,QAAQ;AACf,WAAA;AAAA,MACL,GAAG;AAAA,MACH,QAAQ;AAAA,QACN,MAAMC,OAAAA,WAAW;AAAA,QACjB,mBAAmB;AAAA,MACrB;AAAA,IAAA;AAAA,EAEJ;AACO,SAAA;AAAA,IACL,GAAG;AAAA,IACH,QAAQ;AAAA,MACN,GAAG,WAAW;AAAA,MACd,MAAM,WAAW,OAAO,OAAO,WAAW,OAAO,OAAOA,kBAAW;AAAA,MACnE,mBAAmB;AAAA,IACrB;AAAA,EAAA;AAEJ;AAEA,MAAM,YAAY,OAAO,SAAiB;AACpC,MAAA;AACF,UAAM,QAAQ;AAEd,UAAMC,eAAAA,QAAM,4CAA4C;AAAA,MACtD,QAAQ;AAAA,MACR,MAAM,KAAK,UAAU;AAAA,QACnB;AAAA,QACA,UAAUC,UAAU;AAAA,QACpB,iBAAiB,EAAE,WAAW,KAAK;AAAA,MAAA,CACpC;AAAA,MACD,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,kBAAkB;AAAA,MACpB;AAAA,IAAA,CACD;AAAA,WACM,GAAG;AAAA,EAEZ;AACF;AAEA,eAAe,iBAAiB;AAC9B,QAAM,kBAAkBC,KAAAA,QAAQ,QAAQ,OAAO,cAAc;AAC7D,QAAM,SAAS,MAAML,aAAAA,QAAI,WAAW,eAAe;AAEnD,MAAI,CAAC,QAAQ;AACX,YAAQ,IAAI,GAAGC,eAAA,QAAM,OAAO,SAAS,CAAC,+BAA+B;AACrE,YAAQ,KAAK,CAAC;AAAA,EAChB;AAEM,QAAA,aAAa,MAAM,gBAAgB,eAAe;AAExD,MAAI,WAAW,UAAU,WAAW,OAAO,MAAM;AAC3C,QAAA,WAAW,OAAO,sBAAsB,OAAO;AACjD,cAAQ,IAAI,GAAGA,eAAA,QAAM,OAAO,UAAU,CAAC,+BAA+B;AACtE,cAAQ,KAAK,CAAC;AAAA,IAChB;AAAA,EACF;AAEM,QAAA,qBAAqB,uBAAuB,UAAU;AAE5D,QAAM,QAAQ,MAAM,iBAAiB,iBAAiB,oBAAoB,CAAC;AAE3E,MAAI,CAAC,OAAO;AACV,YAAQ,KAAK,CAAC;AAAA,EAChB;AAEM,QAAA,UAAU,mBAAmB,OAAO,IAAI;AAC9C,UAAQ,IAAI,GAAGA,eAAAA,QAAM,MAAM,sDAAsD,CAAC,EAAE;AACpF,UAAQ,KAAK,CAAC;AAChB;;"}